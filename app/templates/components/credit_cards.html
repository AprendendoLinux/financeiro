<div class="h-full flex flex-col">
    <div class="flex items-center justify-between mb-3 px-1">
        <h3 class="text-sm font-bold text-sky-400 uppercase flex items-center">
            <i class="fas fa-credit-card mr-2"></i> Faturas de Cartão
        </h3>
        <div class="text-xs text-slate-500 font-mono bg-slate-800 px-2 py-1 rounded-full border border-slate-700">
            <span id="card-counter">1</span>/{{ cards_data|length }}
        </div>
    </div>

    {% set is_current_view = (current_month == today.month and current_year == today.year) %}

    <div class="relative w-full flex-1 rounded-xl shadow-2xl overflow-hidden group border border-slate-700/50">
        
        <button onclick="moveCarousel('card', -1)" class="absolute left-1 top-1/2 -translate-y-1/2 z-20 p-2 text-white/50 hover:text-white hover:bg-black/20 rounded-full transition backdrop-blur-sm sm:left-2 sm:p-3">
            <i class="fas fa-chevron-left text-lg sm:text-xl"></i>
        </button>
        <button onclick="moveCarousel('card', 1)" class="absolute right-1 top-1/2 -translate-y-1/2 z-20 p-2 text-white/50 hover:text-white hover:bg-black/20 rounded-full transition backdrop-blur-sm sm:right-2 sm:p-3">
            <i class="fas fa-chevron-right text-lg sm:text-xl"></i>
        </button>

        <div class="relative w-full h-full min-h-[220px]">
            {% for card in cards_data|sort(attribute='invoice_amount', reverse=True) %}
            
            {# --- Lógica Visual Baseada em BANCO e BANDEIRA Separados --- #}
            
            {# 1. Ícone pela BANDEIRA (Brand) #}
            {% set brand = card.obj.brand|lower if card.obj.brand else 'other' %}
            {% set brand_icon = "fa-credit-card" %}
            
            {% if brand == 'visa' %}
                {% set brand_icon = "fa-cc-visa" %}
            {% elif brand == 'mastercard' %}
                {% set brand_icon = "fa-cc-mastercard" %}
            {% elif brand == 'amex' %}
                {% set brand_icon = "fa-cc-amex" %}
            {% endif %}

            {# 2. Cor pelo BANCO (Bank) #}
            {% set bank = card.obj.bank|lower if card.obj.bank else 'other' %}
            
            {% if card.is_paid %}
                {# Fatura Paga = Verde (Prioridade Máxima) #}
                {% set bg_card = "bg-gradient-to-br from-emerald-800 to-emerald-950" %}
                {% set status_text = "Fatura Paga" %}
                {% set status_class = "bg-emerald-500/20 text-emerald-300 border-emerald-500/30" %}
                {% set bar_color = "bg-emerald-400" %}
            {% else %}
                {# Fatura Aberta: Cores por BANCO #}
                {% if bank == 'nubank' %}
                    {% set bg_card = "bg-gradient-to-br from-purple-900 to-purple-950" %}
                {% elif bank == 'itau' %}
                    {% set bg_card = "bg-gradient-to-br from-orange-800 to-slate-900" %}
                {% elif bank == 'inter' %}
                    {% set bg_card = "bg-gradient-to-br from-orange-600 to-orange-800" %}
                {% elif bank == 'bradesco' %}
                    {% set bg_card = "bg-gradient-to-br from-red-800 to-red-950" %}
                {% elif bank == 'santander' %}
                    {% set bg_card = "bg-gradient-to-br from-red-700 to-red-900" %}
                {% elif bank == 'bb' %}
                    {% set bg_card = "bg-gradient-to-br from-yellow-500 to-yellow-700" %}
                {% elif bank == 'c6' %}
                    {% set bg_card = "bg-gradient-to-br from-slate-900 to-black" %}
                {% elif bank == 'caixa' %}
                    {% set bg_card = "bg-gradient-to-br from-blue-700 to-blue-900" %}
                {% elif bank == 'btg' %}
                    {% set bg_card = "bg-gradient-to-br from-blue-900 to-slate-900" %}
                {% elif bank == 'xp' %}
                    {% set bg_card = "bg-gradient-to-br from-gray-900 to-black border-t border-yellow-500/30" %}
                {% else %}
                    {# Padrão (Outros Bancos) #}
                    {% set bg_card = "bg-gradient-to-br from-slate-700 to-slate-900" %}
                {% endif %}
                
                {% set status_text = "Fatura Aberta" %}
                {% set status_class = "bg-sky-500/20 text-sky-300 border-sky-500/30" %}
                
                {% if card.percent > 90 %}
                    {% set bar_color = "bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]" %}
                {% else %}
                    {% set bar_color = "bg-sky-400 shadow-[0_0_10px_rgba(56,189,248,0.5)]" %}
                {% endif %}
            {% endif %}

            <div class="carousel-item-card absolute inset-0 w-full h-full p-4 sm:p-5 flex flex-col justify-between transition-opacity duration-300 {{ bg_card }} {% if not loop.first %}opacity-0 pointer-events-none{% else %}opacity-100 z-10{% endif %}" data-index="{{ loop.index }}">
                
                <div class="absolute -right-6 -bottom-10 opacity-10 text-[8rem] sm:text-[10rem] text-white pointer-events-none">
                    <i class="fab {{ brand_icon }}"></i>
                </div>

                <div class="z-10 w-full flex justify-between items-start px-4 sm:px-8">
                    <div>
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fab {{ brand_icon }} text-2xl text-white/90"></i>
                            <h4 class="text-white font-bold text-base sm:text-lg tracking-wide shadow-black drop-shadow-sm truncate max-w-[120px] sm:max-w-none">{{ card.obj.name }}</h4>
                        </div>
                        
                        <div class="flex flex-col space-y-1 ml-0.5">
                            <p class="text-xs text-white/70">Vence: <span class="text-white font-medium">{{ card.full_due_date }}</span></p>
                            <p class="text-xs text-white/50">Fecha: {{ card.obj.closing_day }}</p>
                        </div>
                    </div>
                    
                    <div class="px-2 py-1 rounded text-[10px] sm:text-xs font-bold border uppercase tracking-wider backdrop-blur-md {{ status_class }}">
                        {{ status_text }}
                    </div>
                </div>

                <div class="z-10 w-full flex flex-col justify-center items-center py-2">
                    <div class="w-3/4 flex justify-between text-xs text-white/60 mb-1 px-1 font-medium">
                        <span>Disp: R$ {{ "%.0f"|format(card.available) }}</span>
                        <span>{{ "%.0f"|format(card.percent) }}% Usado</span>
                    </div>
                    <div class="w-3/4 bg-black/40 rounded-full h-1 border border-white/5 overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-700 {{ bar_color }}" style="width: {{ card.percent }}%"></div>
                    </div>
                </div>

                <div class="z-10 w-full flex items-end justify-start mt-auto space-x-2 sm:space-x-4 pl-1 sm:pl-2">
                    
                    <div>
                        <p class="text-white/70 text-[10px] sm:text-xs uppercase font-bold mb-1 ml-0.5">Total da Fatura</p>
                        <p class="text-2xl sm:text-3xl font-bold text-white tracking-tight drop-shadow-md leading-none">
                            <span class="text-xs sm:text-sm align-top opacity-60 mr-0.5">R$</span>{{ "%.2f"|format(card.invoice_amount)|replace('.', ',') }}
                        </p>
                    </div>

                    <div class="flex flex-col space-y-1 mb-0.5">
                        {% if not card.is_paid %}
                            <button onclick="openPayCardModal('{{ card.obj.id }}', '{{ card.obj.name }}', '{{ card.invoice_amount }}')" 
                                    class="bg-white hover:bg-slate-100 text-slate-900 text-[10px] font-bold py-1.5 px-2 sm:px-3 rounded shadow-lg transition disabled:opacity-50 hover:scale-105 active:scale-95 text-center whitespace-nowrap"
                                    {% if not is_current_view %}disabled{% endif %}>
                                Pagar
                            </button>
                        {% endif %}
                        
                        <button onclick="openAdvanceModal('{{ card.obj.id }}', '{{ card.obj.name }}')" 
                                class="bg-black/30 hover:bg-black/50 text-white text-[10px] font-bold py-1.5 px-2 sm:px-3 rounded border border-white/10 transition disabled:opacity-50 hover:border-white/30 text-center whitespace-nowrap"
                                {% if not is_current_view %}disabled{% endif %}>
                            Antecipar
                        </button>
                    </div>
                </div>

            </div>
            {% else %}
             <div class="h-full flex items-center justify-center bg-slate-800 text-slate-500 p-6 text-center">
                <div>
                    <i class="fas fa-credit-card text-4xl mb-3 opacity-30"></i>
                    <p>Nenhum cartão cadastrado.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>